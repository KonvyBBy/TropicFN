<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Konvy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">K</div>

    <nav>
      <button class="nav-btn active" data-section="home">ğŸ </button>
      <button class="nav-btn" data-section="search">ğŸ”</button>
      {% if logged_in %}
        <button class="nav-btn" data-section="balance">ğŸ’³</button>
        <button class="nav-btn" data-section="accounts">ğŸ“¦</button>
        <button class="nav-btn" data-section="redeem">ğŸŸï¸</button>
        {% if purchases|length > 0 %}
          <button class="nav-btn" data-section="secure">ğŸ”’</button>
        {% endif %}
      {% endif %}
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- HEADER -->
    <header class="topbar">
      <div>
        <h1>Dashboard</h1>
        <span>
          {% if logged_in %}
            Welcome back, {{ username }}
          {% else %}
            Browsing as Guest
          {% endif %}
        </span>
      </div>

      <div class="header-right">
        <button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle theme">
          <span class="icon">ğŸŒ™</span>
          <span class="label">Dark Mode</span>
        </button>
        {% if logged_in %}
          <div class="pill">Balance: ${{ balance }}</div>
          <a href="{{ url_for('warranty') }}" class="pill" style="text-decoration: none;">Warranty</a>
          <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        {% else %}
          <a href="{{ url_for('login') }}" class="pill" style="text-decoration: none;">Login</a>
          <a href="{{ url_for('register') }}" class="pill" style="text-decoration: none;">Sign Up</a>
        {% endif %}
      </div>
    </header>

    <!-- SKINS MODAL -->
    <div id="skins-modal" class="skins-modal">
      <div class="skins-modal-content">
        <div class="skins-modal-header">
          <h2>Account Skins</h2>
          <button class="skins-close" onclick="closeSkinsModal()">âœ•</button>
        </div>
        <div id="skins-grid" class="skins-grid"></div>
        <div id="skins-loader" class="skins-loader">
          <div class="loader-spinner"></div>
          <div class="loader-text">Loading Preview...</div>
          <div class="loader-progress">
            <span id="skins-loaded">0</span> / <span id="skins-total">0</span>
          </div>
          <div class="loader-count">
            Loading skins in optimized batches for faster preview
          </div>
        </div>
      </div>
    </div>

    <!-- HOME -->
    <section class="section" id="section-home">
      {% if logged_in %}
        <div class="grid-4">
          <div class="card">
            <span>Balance</span>
            <strong>${{ balance }}</strong>
          </div>
          <div class="card">
            <span>Purchases</span>
            <strong>{{ purchases|length }}</strong>
          </div>
          <div class="card">
            <span>Status</span>
            <strong>Active</strong>
          </div>
          <div class="card">
            <span>Tier</span>
            <strong>Visitor</strong>
          </div>
        </div>

        <div class="card large">
          <h3>Recent Purchases</h3>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Item</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for p in purchases[:5] %}
              <tr>
                <td>{{ p.timestamp }}</td>
                <td>{{ p.latest_order.title if p.latest_order }}</td>
                <td>Paid</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3">No purchases yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <!-- GUEST WELCOME -->
        <div class="card large">
          <h2>Welcome to Konvy Accounts! ğŸ®</h2>
          <p style="margin: 16px 0; font-size: 1.05rem; line-height: 1.6;">
            Browse thousands of Fortnite accounts with rare skins, high levels, and V-Bucks.
            Search by any cosmetic item to find your perfect account.
          </p>
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <a href="{{ url_for('register') }}" class="btn-primary">Create Account</a>
            <a href="{{ url_for('login') }}" class="btn-secondary">Sign In</a>
          </div>
        </div>

        <div class="card">
          <h3>Why Choose Konvy?</h3>
          <ul style="margin: 12px 0; line-height: 2;">
            <li>âœ… Instant delivery of account credentials</li>
            <li>âœ… Search by specific skins and cosmetics</li>
            <li>âœ… Secure payment through Shopify</li>
            <li>âœ… Browse without signing up</li>
            <li>âœ… 11+ day warranty on inactive accounts</li>
          </ul>
        </div>
      {% endif %}
    </section>

{% if logged_in and purchases|length > 0 %}
    <section class="section" id="section-secure">
      <div class="card large secure-card">
        <h2>ğŸ”’ Important: Account Security & Warranty Instructions</h2>
        <p class="warn">
          âš ï¸ Attention all buyers: To ensure your purchased account is fully secure
          and eligible for warranty, you must follow the security procedure outlined in the video below.
        </p>
        
        <h3>ğŸ¥ Video Guide</h3>
        <p>
          <a href="https://youtu.be/ykQsz5QrZkg" target="_blank">
            https://youtu.be/ykQsz5QrZkg
          </a>
        </p>
        
        <h3>ğŸ’¡ Why This Matters</h3>
        <p>Properly securing your account:</p>
        <ul>
          <li>Protects it from unauthorized access</li>
          <li>Ensures it stays fully functional</li>
          <li>Maintains your warranty eligibility</li>
        </ul>
        
        <p class="danger">
          âŒ Important: Accounts played in tournaments or not secured according to this guide 
          are NOT eligible for refunds or warranty claims.
        </p>
        
        <h3>ğŸ“‹ Step-by-Step Instructions</h3>
        
        <h4>ğŸ“± iPhone Users:</h4>
        <ul>
          <li>Use the screen recording feature on your device while following the steps in the video.</li>
          <li>Make sure the recording clearly shows every step being completed.</li>
        </ul>
        
        <h4>ğŸ’» Computer Users:</h4>
        <p>You have two options:</p>
        <ul>
          <li>Record your screen using your phone while following the guide, OR</li>
          <li>Use GeForce Experience or any reliable screen recording software to capture your actions.</li>
        </ul>
        
        <p><strong>ğŸ’¡ Tip:</strong> Make sure the recording clearly shows:</p>
        <ul>
          <li>Login steps</li>
          <li>Password changes</li>
          <li>Any security settings you update</li>
        </ul>
        
        <h3>ğŸ›¡ï¸ Warranty Requirement</h3>
        <ul>
          <li>Completing this procedure is <strong>mandatory</strong> for your account warranty.</li>
          <li>Accounts not secured properly will not qualify for refunds.</li>
          <li>Warranty claims for unsecured accounts will be denied.</li>
          <li><strong>Submit another request every time they say yours is denied (for up to 2 weeks).</strong></li>
        </ul>
        
        <p class="warn">
          âš ï¸ Reminder: This step protects your purchase and ensures your account stays secure. Do not skip it.
        </p>
      </div>
    </section>
    {% endif %}

<!-- SEARCH (AVAILABLE TO ALL) -->
<section class="section" id="section-search">
  <div class="search-hero">
    <h2>ğŸ” Search Fortnite Accounts</h2>
    <p>Find accounts with your favorite skins, emotes, and cosmetics</p>
  </div>

  <div class="card search-card">
    <h3>Search Filters</h3>
    
    <form id="search-form">
      <!-- Items Section -->
      <div class="filter-section">
        <label class="filter-label">Items to Search</label>
        <div id="items-container">
          <div class="item-input-row">
            <div class="autocomplete-wrapper">
              <input 
                type="text" 
                class="item-search-input" 
                placeholder="Type item name: Black Knight, Floss..." 
                autocomplete="off">
              <div class="autocomplete-dropdown"></div>
            </div>
            <button type="button" class="remove-item-btn" style="display:none;">âœ•</button>
          </div>
        </div>
        <button type="button" id="add-item-btn" class="add-btn">+ Add Another Item</button>
      </div>

      <!-- Budget Input (replaces slider) -->
      <div class="filter-section">
        <label class="filter-label">Budget (Max Price)</label>
        <input 
          id="budget-input"
          name="budget" 
          type="number" 
          class="filter-input" 
          placeholder="Enter maximum price (e.g., 250)" 
          min="0"
          step="1">
        <span class="filter-hint">Leave blank for no budget limit</span>
      </div>

      <!-- Other Filters -->
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">Days Offline</label>
          <input name="days" type="number" placeholder="0 = any" min="0" value="0" class="filter-input">
          <span class="filter-hint">Minimum days since last played</span>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Minimum Skins</label>
          <input name="skins" type="number" placeholder="0 = any" min="0" value="0" class="filter-input">
          <span class="filter-hint">Total number of skins required</span>
        </div>
      </div>

      <button type="submit" class="search-submit-btn">
        ğŸ” Search Accounts
      </button>
    </form>
  </div>

  <!-- Results -->
  <div id="search-results-container">
    <div id="search-results" class="results-grid"></div>
  </div>
</section>

    {% if logged_in %}
    <!-- BALANCE -->
    <section class="section" id="section-balance">
      <div class="grid-2">
        <div class="card">
          <h3>ğŸ’° Check Balance</h3>
          
          <div class="info-box small">
            <div class="info-icon">ğŸ’¡</div>
            <div class="info-content">
              Click to view your current account balance.
            </div>
          </div>

          <button id="check-balance-btn">Check Balance</button>
          <div id="balance-result"></div>
        </div>

        <div class="card">
          <h3>ğŸ’³ Add Funds</h3>
          
          <div class="info-box small">
            <div class="info-icon">ğŸ’¡</div>
            <div class="info-content">
              Enter an amount and we'll generate a secure Shopify checkout link. 
              <strong>After payment, use the Redeem tab</strong> with your order number.
            </div>
          </div>

          <input id="topup-amount" type="number" step="0.01" value="10" placeholder="Amount in USD">
          <button id="topup-btn">ğŸ’³ Generate Payment Link</button>
          <div id="topup-result"></div>
        </div>
      </div>
    </section>

    <!-- ACCOUNTS -->
    <section class="section" id="section-accounts">
      <div class="card large">
        <h3>ğŸ“¦ My Accounts</h3>
        
        <div class="info-box">
          <div class="info-icon">ğŸ’¡</div>
          <div class="info-content">
            <strong>Your purchased accounts appear here.</strong> Use the buttons below to browse 
            through your purchases. Copy the login credentials to access your Fortnite account.
          </div>
        </div>

        <div id="my-accounts-view"></div>

        <div class="pager">
          <button id="prev-account">â† Previous</button>
          <span id="account-indicator"></span>
          <button id="next-account">Next â†’</button>
        </div>
      </div>
    </section>

    <!-- REDEEM -->
    <section class="section" id="section-redeem">
      <div class="card">
        <h3>ğŸŸï¸ Redeem Balance</h3>
        
        <div class="info-box">
          <div class="info-icon">ğŸ’¡</div>
          <div class="info-content">
            <strong>How to redeem:</strong>
            <ol style="margin: 8px 0 0 20px; padding: 0;">
              <li>Generate a payment link in the <strong>Add Funds</strong> tab</li>
              <li>Complete payment on Shopify</li>
              <li>Find your order number (e.g., <strong>1234</strong>)</li>
              <li>Enter it below and click Redeem to add funds to your balance</li>
            </ol>
          </div>
        </div>

        <input id="redeem-order" type="number" placeholder="Order number (without #)">
        <button id="redeem-btn">ğŸŸï¸ Redeem Order</button>
        <div id="redeem-result"></div>
      </div>
    </section>
    {% endif %}

  </main>
</div>

<script>
  window.KONVY_LOGGED_IN = {{ 'true' if logged_in else 'false' }};
</script>
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>